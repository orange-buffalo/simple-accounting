"GraphQL schema for Simple Accounting application"
schema @contact(description : "For any questions, issues or feature requests, please open an issue or discussion on GitHub.", name : "Simple Accounting", url : "https://github.com/orange-buffalo/simple-accounting/issues"){
  query: Query
  mutation: Mutation
}

"Defines the authorization requirements for the request. If a request context does not satisfy the requirements, it will be rejected with an error code `NOT_AUTHORIZED`."
directive @auth(type: AuthType!) on FIELD_DEFINITION

"Declares a business error that can be returned by this operation. When the specified exception is thrown, the response will include an error with extensions.errorType = 'BUSINESS_ERROR' and extensions.errorCode containing the declared error code."
directive @businessError(description: String!, errorCode: String!) repeatable on FIELD_DEFINITION

"Provides contact information of the owner responsible for this subgraph schema."
directive @contact(description: String!, name: String!, url: String!) on SCHEMA

"This directive allows results to be deferred during execution"
directive @defer(
    "Deferred behaviour is controlled by this argument"
    if: Boolean! = true,
    "A unique label that represents the fragment being deferred"
    label: String
  ) on FRAGMENT_SPREAD | INLINE_FRAGMENT

"Marks the field, argument, input field or enum value as deprecated"
directive @deprecated(
    "The reason for the deprecation"
    reason: String! = "No longer supported"
  ) on FIELD_DEFINITION | ARGUMENT_DEFINITION | ENUM_VALUE | INPUT_FIELD_DEFINITION

"This directive disables error propagation when a non nullable field returns null for the given operation."
directive @experimental_disableErrorPropagation on QUERY | MUTATION | SUBSCRIPTION

"Directs the executor to include this field or fragment only when the `if` argument is true"
directive @include(
    "Included when true."
    if: Boolean!
  ) on FIELD | FRAGMENT_SPREAD | INLINE_FRAGMENT

"Validates that the string is not null, empty, or blank"
directive @notBlank on ARGUMENT_DEFINITION | INPUT_FIELD_DEFINITION

"Indicates an Input Object is a OneOf Input Object."
directive @oneOf on INPUT_OBJECT

"Validates the size of a string"
directive @size(
    "Maximum size"
    max: Int!,
    "Minimum size"
    min: Int!
  ) on ARGUMENT_DEFINITION | INPUT_FIELD_DEFINITION

"Directs the executor to skip this field or fragment when the `if` argument is true."
directive @skip(
    "Skipped when true."
    if: Boolean!
  ) on FIELD | FRAGMENT_SPREAD | INLINE_FRAGMENT

"Exposes a URL that specifies the behaviour of this scalar."
directive @specifiedBy(
    "The URL that specifies the behaviour of this scalar."
    url: String!
  ) on SCALAR

"Additional error extensions for the ACCOUNT_LOCKED business error."
type AccountLockedErrorExtensions {
  "The remaining lock duration in seconds."
  lockExpiresInSec: Int!
}

"Category of incomes or expenses."
type CategoryGqlDto {
  "Name of the category."
  name: String!
}

"Response for the changePassword mutation. Always succeeds if no error is returned by standard GraphQL error response structure."
type ChangePasswordResponse {
  success: Boolean!
}

"Response for the completeOAuth2Flow mutation."
type CompleteOAuth2FlowResponse {
  "An error reference ID that can be used to identify the specific failure in the logs. Present only when the flow failed."
  errorId: String
  "Whether the OAuth2 authorization flow was completed successfully."
  success: Boolean!
}

"Response for the createAccessTokenByCredentials mutation."
type CreateAccessTokenByCredentialsResponse {
  "The JWT access token for the authenticated user."
  accessToken: String!
}

"Business expense."
type ExpenseGqlDto {
  "Category of the expense."
  category: CategoryGqlDto
  "Title of the expense."
  title: String!
}

"Internationalization settings of the user profile."
type I18nSettings {
  "The language of the user profile, e.g. 'en'. Used for translations."
  language: String!
  "The locale of the user profile, e.g. 'en-US'. Used for formatting dates, numbers, etc."
  locale: String!
}

type Mutation {
  "Changes the password of the current user."
  changePassword(
    "The current password of the user."
    currentPassword: String! @notBlank @size(max : 100, min : 0),
    "The new password to set for the user."
    newPassword: String! @notBlank @size(max : 100, min : 0)
  ): ChangePasswordResponse! @auth(type : AUTHENTICATED_USER) @businessError(description : "The provided current password does not match the user's actual password.", errorCode : "CURRENT_PASSWORD_MISMATCH")
  "Completes the OAuth2 authorization flow by processing the authorization server callback."
  completeOAuth2Flow(
    "The authorization code returned by the authorization server."
    code: String,
    "The error code returned by the authorization server if authorization failed."
    error: String,
    "The state token that was included in the authorization request."
    state: String!
  ): CompleteOAuth2FlowResponse! @auth(type : AUTHENTICATED_USER)
  "Authenticates a user by username and password credentials and returns an access token. Optionally issues a refresh token cookie for persistent sessions."
  createAccessTokenByCredentials(
    "Whether to issue a refresh token cookie for persistent sessions. Defaults to false if not provided."
    issueRefreshTokenCookie: Boolean,
    "The password of the user."
    password: String! @notBlank,
    "The username of the user."
    userName: String! @notBlank
  ): CreateAccessTokenByCredentialsResponse! @auth(type : ANONYMOUS) @businessError(description : "The provided credentials are invalid.", errorCode : "BAD_CREDENTIALS") @businessError(description : "The user account has not been activated yet.", errorCode : "USER_NOT_ACTIVATED") @businessError(description : "The account is temporarily locked due to too many failed login attempts. The error extensions will include 'lockExpiresInSec' with the remaining lock duration in seconds.", errorCode : "ACCOUNT_LOCKED") @businessError(description : "Login is temporarily unavailable due to too many concurrent authentication requests for this user.", errorCode : "LOGIN_NOT_AVAILABLE")
  "Invalidates the refresh token cookie, effectively logging out the current user."
  invalidateRefreshToken: Boolean! @auth(type : ANONYMOUS)
  "Refreshes the access token using the refresh token from cookies or current authentication. Returns a response with either a valid access token or null if authentication fails."
  refreshAccessToken: RefreshAccessTokenResponse! @auth(type : ANONYMOUS)
}

type Query {
  "Returns the current user profile information. Current is defined as the user that is authenticated in the current request."
  userProfile: UserProfile! @auth(type : AUTHENTICATED_USER)
  "Returns all workspaces accessible by the current user."
  workspaces: [WorkspaceGqlDto!]! @auth(type : REGULAR_USER)
}

"Response for refreshing access token."
type RefreshAccessTokenResponse {
  "The new access token if authentication was successful, null otherwise."
  accessToken: String
}

"Information about the user profile."
type UserProfile {
  "The identifier of the documents storage used by the user."
  documentsStorage: String
  "Internationalization settings of the user."
  i18n: I18nSettings!
  "The user name / login of the user."
  userName: String!
}

"Details of a field validation error that occurred during input validation."
type ValidationErrorDetails {
  "The error code identifying the type of validation failure."
  error: ValidationErrorCode!
  "A human-readable message describing the validation failure."
  message: String!
  "Additional constraint parameters if applicable (e.g., min/max values for size constraints)."
  params: [ValidationErrorParam!]
  "The path to the field that failed validation (e.g., 'currentPassword')."
  path: String!
}

"A key-value pair for validation constraint parameters."
type ValidationErrorParam {
  "The parameter name (e.g., 'min', 'max')."
  name: String!
  "The parameter value."
  value: String!
}

"Workspace of a user."
type WorkspaceGqlDto {
  "Categories in this workspace."
  categories: [CategoryGqlDto!]!
  "Expenses in this workspace."
  expenses: [ExpenseGqlDto!]!
  "Name of the workspace."
  name: String!
}

"Defines the type of authorization required to execute the request. This is used in conjunction with the `@auth` directive."
enum AuthType {
  "Requires a request to be executed by an admin user, i.e. authenticated and has admin privileges."
  ADMIN_USER
  "Allows a request to be executed by an anonymous user, i.e. not authenticated at all. With this restriction, any authenticated user is allowed to execute the request too. "
  ANONYMOUS
  "Allows a request to be executed by any authenticated actor, including by workspace access token."
  AUTHENTICATED_ACTOR
  "Allows a request to be executed by any authenticated user, be it admin or regular user, but not via workspace access token."
  AUTHENTICATED_USER
  "Requires a request to be executed by a regular user, i.e. authenticated and not an admin user."
  REGULAR_USER
}

"Possible business error codes for the changePassword operation."
enum ChangePasswordErrorCodes {
  "The provided current password does not match the user's actual password."
  CURRENT_PASSWORD_MISMATCH
}

"Possible business error codes for the createAccessTokenByCredentials operation."
enum CreateAccessTokenByCredentialsErrorCodes {
  "The account is temporarily locked due to too many failed login attempts. The error extensions will include 'lockExpiresInSec' with the remaining lock duration in seconds."
  ACCOUNT_LOCKED
  "The provided credentials are invalid."
  BAD_CREDENTIALS
  "Login is temporarily unavailable due to too many concurrent authentication requests for this user."
  LOGIN_NOT_AVAILABLE
  "The user account has not been activated yet."
  USER_NOT_ACTIVATED
}

"Defines the error types that can be returned in GraphQL errors. These error types are included in the `extensions.errorType` field of GraphQL errors."
enum SaGrapQlErrorType {
  "Indicates that a business error occurred during the operation. The specific error code will be provided in `extensions.errorCode`."
  BUSINESS_ERROR
  "Indicates that one or more input fields failed validation constraints."
  FIELD_VALIDATION_FAILURE
  "Indicates that the request requires authentication or the user is not authorized to perform the operation."
  NOT_AUTHORIZED
}

"Error codes for validation failures, matching REST API constraint violation error keys."
enum ValidationErrorCode {
  "The field must not be null, empty, or blank."
  MustNotBeBlank
  "The field size must be within the specified min/max bounds."
  SizeConstraintViolated
}
