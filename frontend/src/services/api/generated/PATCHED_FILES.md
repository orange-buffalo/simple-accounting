# Manually Patched Generated Files

This directory contains TypeScript API client files generated by OpenAPI Generator.
Some of these files have been manually patched to fix bugs in the generated code.

## Timezone-Dependent Date Serialization Bug

**Issue**: The OpenAPI Generator (typescript-fetch) generates date serialization code that uses:
```typescript
'datePaid': ((value['datePaid']).toISOString().substring(0,10))
```

This incorrectly converts dates to UTC before extracting the date string, causing dates to shift by one day
in timezones that are ahead of UTC (like Australia/Melbourne, UTC+11).

**Example of the bug**:
- User in Melbourne selects date: "2023-12-15"
- `ElDatePicker` creates: `new Date("2023-12-15")` → 2023-12-15 00:00:00 Melbourne time (UTC+11)
- `toISOString()` converts to UTC: "2023-12-14T13:00:00.000Z"
- `substring(0,10)` extracts: "2023-12-14" ❌ **Wrong date!**

**Fix**: Created `date-utils.ts` with `formatLocalDateToISO()` function that uses timezone-agnostic methods:
```typescript
export function formatLocalDateToISO(date: Date): string {
  const year = date.getFullYear();       // Uses local timezone
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
```

## Patched Files

The following files have been manually modified:

### New Files
- `date-utils.ts` - Utility for timezone-agnostic date formatting

### Modified Files
All `*ToJSON()` functions in these files have been updated to use `formatLocalDateToISO()`:

1. `models/EditExpenseDto.ts`
2. `models/ExpenseDto.ts`
3. `models/EditIncomeDto.ts`
4. `models/IncomeDto.ts`
5. `models/EditInvoiceDto.ts`
6. `models/InvoiceDto.ts`
7. `models/EditIncomeTaxPaymentDto.ts`
8. `models/IncomeTaxPaymentDto.ts`

### Changes Made

In each file:
1. Added import: `import { formatLocalDateToISO } from '../date-utils';`
2. Replaced all occurrences of:
   - `((value['fieldName']).toISOString().substring(0,10))` 
   - with: `formatLocalDateToISO(value['fieldName'])`
3. For optional fields, replaced:
   - `value['field'] == null ? undefined : ((value['field']).toISOString().substring(0,10))`
   - with: `value['field'] == null ? undefined : formatLocalDateToISO(value['field'])`

## Regenerating Files

When regenerating the API client:

1. Run the OpenAPI Generator as normal
2. Re-apply the patches:
   - Copy `date-utils.ts` if it was overwritten
   - Re-add the import statements
   - Replace `toISOString().substring(0,10)` with `formatLocalDateToISO()` calls
3. Run tests to verify the fix still works:
   ```bash
   TZ=Australia/Melbourne ./gradlew :app:test --tests "DatePickerFullStackTest"
   ```

## Test Coverage

The fix is validated by:
- All tests in `DatePickerFullStackTest` pass when run with `TZ=Australia/Melbourne`
- Frontend type checking passes: `cd frontend && bun run typecheck`

## Related Issues

- Original Issue: "DatePickerFullStackTest is timezone dependent"
- Root Cause: OpenAPI Generator bug - uses UTC conversion for LocalDate serialization
